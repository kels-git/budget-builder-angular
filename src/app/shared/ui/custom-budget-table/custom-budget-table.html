<div class="bg-white rounded-lg shadow-sm overflow-hidden">
  <div class="overflow-x-auto">
    <table class="w-full border-collapse min-w-[1200px]">
      <!-- Header -->
      <thead class="bg-gray-100 sticky top-0 z-10">
        <tr>
          <th
            class="px-4 py-3 text-left text-sm font-semibold text-gray-700 border-b-2 border-gray-300 w-64 sticky left-0 bg-gray-100 z-20"
          >
            Category
          </th>
          <th
            *ngFor="let month of months"
            class="px-4 py-3 text-right text-sm font-semibold text-gray-700 border-b-2 border-gray-300 w-32"
          >
            {{ month.name }} {{ month.year }}
          </th>
          <th
            *ngIf="config.showTotalColumn"
            class="px-4 py-3 text-right text-sm font-semibold text-gray-700 border-b-2 border-gray-300 w-32"
          >
            Total
          </th>
          <th class="px-4 py-3 border-b-2 border-gray-300 w-16"></th>
        </tr>
      </thead>

      <tbody>
        <!-- Opening Balance -->
        <tr *ngIf="config.showOpeningBalance" class="bg-blue-50">
          <td
            class="px-4 py-3 font-semibold text-gray-900 border-b border-gray-200 sticky left-0 bg-blue-50 z-10"
          >
            Opening Balance
          </td>
          <td
            *ngFor="let month of months"
            class="px-4 py-3 text-right font-medium text-gray-900 border-b border-gray-200"
          >
            ${{ formatCurrency(openingBalances[month.key] || 0) }}
          </td>
          <td
            *ngIf="config.showTotalColumn"
            class="px-4 py-3 border-b border-gray-200"
          ></td>
          <td class="px-4 py-3 border-b border-gray-200"></td>
        </tr>

        <!-- Income Section -->
        <tr class="bg-green-50">
          <td
            (click)="toggleSection('income')"
            class="px-4 py-3 font-bold text-green-800 border-b border-gray-200 cursor-pointer sticky left-0 bg-green-50 z-10"
          >
            <div class="flex items-center gap-2">
              <mat-icon class="!w-5 !h-5">
                {{ expandedSections.income ? 'expand_more' : 'chevron_right' }}
              </mat-icon>
              <span>INCOME</span>
            </div>
          </td>
          <td
            *ngFor="let month of months"
            class="px-4 py-3 text-right font-bold text-green-800 border-b border-gray-200"
          >
            ${{ formatCurrency(incomeTotals[month.key] || 0) }}
          </td>
          <td
            *ngIf="config.showTotalColumn"
            class="px-4 py-3 text-right font-bold text-green-800 border-b border-gray-200"
          >
            ${{ formatCurrency(getTotalIncome()) }}
          </td>
          <!-- <td class="px-4 py-3 border-b border-gray-200">
            <button
              mat-mini-fab
              color="primary"
              (click)="onAddCategory('income')"
              class="!bg-green-500 hover:!bg-green-600 !scale-75"
              matTooltip="Add Income Category"
            >
              <mat-icon class="!scale-90">add</mat-icon>
            </button>
          </td> -->

          <td class="px-4 py-3 border-b border-gray-200">
            <div class="flex gap-1">
              <button
                mat-mini-fab
                color="primary"
                (click)="onAddParentCategory('income')"
                class="!bg-green-600 hover:!bg-green-700 !scale-75"
                matTooltip="Add Income Group"
              >
                <mat-icon class="!scale-90">folder</mat-icon>
              </button>
              <button
                mat-mini-fab
                color="primary"
                (click)="onAddCategory('income')"
                class="!bg-green-500 hover:!bg-green-600 !scale-75"
                matTooltip="Add Income Row"
              >
                <mat-icon class="!scale-90">add</mat-icon>
              </button>
            </div>
          </td>

        </tr>

        <!-- Income Categories with Parent/Child Support -->
        <ng-container *ngIf="expandedSections.income">
          <ng-container
            *ngFor="let category of getOrganizedCategories('income'); trackBy: trackByCategory"
          >
            <!-- Parent Category Row -->
            <tr *ngIf="category.isParent" class="bg-green-100 font-semibold">
              <td
                class="px-4 py-2 border-b border-gray-200 sticky left-0 bg-green-100 z-10"
              >
                <div class="flex items-center gap-2">
                  <mat-icon
                    class="!w-5 !h-5 cursor-pointer"
                    (click)="toggleCategoryExpand(category.id)"
                  >
                    {{ isCategoryExpanded(category.id) ? 'expand_more' :
                    'chevron_right' }}
                  </mat-icon>
                  <input
                    type="text"
                    [value]="category.name"
                    [disabled]="!config.allowEdit"
                    (change)="onCategoryNameChange(category.id, $event)"
                    class="w-full px-2 py-1 font-semibold bg-transparent border border-transparent hover:border-gray-300 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 rounded"
                  />
                </div>
              </td>
              <td
                *ngFor="let month of months; trackBy: trackByMonth"
                class="px-4 py-2 text-right font-semibold border-b border-gray-200"
              >
                ${{ formatCurrency(getParentCategoryTotal(category, month.key))
                }}
              </td>
              <td
                *ngIf="config.showTotalColumn"
                class="px-4 py-2 text-right font-semibold border-b border-gray-200"
              >
                ${{ formatCurrency(getParentCategoryGrandTotal(category)) }}
              </td>
              <td class="px-4 py-2 border-b border-gray-200">
                <button
                  mat-mini-fab
                  color="primary"
                  (click)="onAddChildCategory(category.id)"
                  class="!bg-green-500 hover:!bg-green-600 !scale-75"
                  matTooltip="Add sub-category"
                >
                  <mat-icon class="!scale-90">add</mat-icon>
                </button>
                <button
                  *ngIf="config.allowDelete"
                  mat-mini-fab
                  color="warn"
                  (click)="onDeleteCategory(category.id)"
                  class="!scale-75 ml-1 hover:!bg-red-600"
                  matTooltip="Delete category group"
                >
                  <mat-icon class="!scale-90">delete</mat-icon>
                </button>
              </td>
            </tr>

            <!-- Child Categories (Indented) -->
            <ng-container
              *ngIf="category.isParent && isCategoryExpanded(category.id)"
            >
              <tr
                *ngFor="let child of getChildCategories(category.id)"
                class="hover:bg-gray-50"
              >
                <td
                  class="px-4 py-2 border-b border-gray-200 sticky left-0 bg-white z-10 pl-12"
                >
                  <div class="flex items-center gap-2">
                    <div class="w-4 h-4"></div>
                    <!-- Spacer for alignment -->
                    <input
                      type="text"
                      [value]="child.name"
                      [disabled]="!config.allowEdit"
                      (change)="onCategoryNameChange(child.id, $event)"
                      (keydown.enter)="onAddCategoryAfter(child.id, $event)"
                      class="w-full px-2 py-1 border border-transparent hover:border-gray-300 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 rounded"
                    />
                  </div>
                </td>
                <td
                  *ngFor="let month of months; trackBy: trackByMonth"
                  class="px-4 py-2 border-b border-gray-200"
                >
                  <input
                    type="number"
                    [value]="getCategoryValue(child, month.key)"
                    [disabled]="!config.allowEdit"
                    (blur)="onCellValueChange(child.id, month.key, $event)"
                    (contextmenu)="onContextMenu($event, child.id, month.key)"
                    class="w-full px-2 py-1 text-right border border-transparent hover:border-gray-300 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 rounded"
                    placeholder="0"
                    step="any"
                  />
                </td>
                <td
                  *ngIf="config.showTotalColumn"
                  class="px-4 py-2 text-right font-medium text-gray-700 border-b border-gray-200"
                >
                  ${{ formatCurrency(getCategoryTotal(child)) }}
                </td>
                <td class="px-4 py-2 border-b border-gray-200">
                  <button
                    *ngIf="config.allowDelete"
                    mat-mini-fab
                    color="warn"
                    (click)="onDeleteCategory(child.id)"
                    class="!scale-75 hover:!bg-red-600"
                    matTooltip="Delete sub-category"
                  >
                    <mat-icon class="!scale-90">delete</mat-icon>
                  </button>
                </td>
              </tr>
            </ng-container>

            <!-- Regular Category Row (No Parent) -->
            <tr
              *ngIf="!category.isParent && !category.parentId"
              class="hover:bg-gray-50"
            >
              <td
                class="px-4 py-2 border-b border-gray-200 sticky left-0 bg-white z-10"
              >
                <input
                  type="text"
                  [value]="category.name"
                  [disabled]="!config.allowEdit"
                  (change)="onCategoryNameChange(category.id, $event)"
                  (keydown.enter)="onAddCategoryAfter(category.id, $event)"
                  class="w-full px-2 py-1 border border-transparent hover:border-gray-300 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 rounded"
                />
              </td>
              <td
                *ngFor="let month of months; trackBy: trackByMonth"
                class="px-4 py-2 border-b border-gray-200"
              >
                <input
                  type="number"
                  [value]="getCategoryValue(category, month.key)"
                  [disabled]="!config.allowEdit"
                  (blur)="onCellValueChange(category.id, month.key, $event)"
                  (contextmenu)="onContextMenu($event, category.id, month.key)"
                  class="w-full px-2 py-1 text-right border border-transparent hover:border-gray-300 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 rounded"
                  placeholder="0"
                  step="any"
                />
              </td>
              <td
                *ngIf="config.showTotalColumn"
                class="px-4 py-2 text-right font-medium text-gray-700 border-b border-gray-200"
              >
                ${{ formatCurrency(getCategoryTotal(category)) }}
              </td>
              <td class="px-4 py-2 border-b border-gray-200">
                <button
                  *ngIf="config.allowDelete"
                  mat-mini-fab
                  color="warn"
                  (click)="onDeleteCategory(category.id)"
                  class="!scale-75 hover:!bg-red-600"
                  matTooltip="Delete Category"
                >
                  <mat-icon class="!scale-90">delete</mat-icon>
                </button>
              </td>
            </tr>
          </ng-container>
        </ng-container>

        <!-- Expenses Section -->
        <tr class="bg-red-50">
          <td
            (click)="toggleSection('expenses')"
            class="px-4 py-3 font-bold text-red-800 border-b border-gray-200 cursor-pointer sticky left-0 bg-red-50 z-10"
          >
            <div class="flex items-center gap-2">
              <mat-icon class="!w-5 !h-5">
                {{ expandedSections.expenses ? 'expand_more' : 'chevron_right'
                }}
              </mat-icon>
              <span>EXPENSES</span>
            </div>
          </td>
          <td
            *ngFor="let month of months"
            class="px-4 py-3 text-right font-bold text-red-800 border-b border-gray-200"
          >
            ${{ formatCurrency(expenseTotals[month.key] || 0) }}
          </td>
          <td
            *ngIf="config.showTotalColumn"
            class="px-4 py-3 text-right font-bold text-red-800 border-b border-gray-200"
          >
            ${{ formatCurrency(getTotalExpenses()) }}
          </td>
          <!-- <td class="px-4 py-3 border-b border-gray-200">
            <button
              mat-mini-fab
              color="primary"
              (click)="onAddCategory('expense')"
              class="!bg-green-500 hover:!bg-green-600 !scale-75"
              matTooltip="Add expense row"
            >
              <mat-icon class="!scale-90">add</mat-icon>
            </button>
          </td> -->

          <td class="px-4 py-3 border-b border-gray-200">
            <div class="flex gap-1">
              <button
                mat-mini-fab
                color="primary"
                (click)="onAddParentCategory('expense')"
                class="!bg-red-600 hover:!bg-red-700 !scale-75"
                matTooltip="Add Expense Group"
              >
                <mat-icon class="!scale-90">folder</mat-icon>
              </button>
              <button
                mat-mini-fab
                color="primary"
                (click)="onAddCategory('expense')"
                class="!bg-red-500 hover:!bg-red-600 !scale-75"
                matTooltip="Add Expense Row"
              >
                <mat-icon class="!scale-90">add</mat-icon>
              </button>
            </div>
          </td>
        </tr>

      
        <!-- Expenses Categories with Parent/Child Support -->
        <ng-container *ngIf="expandedSections.expenses">
          <ng-container
            *ngFor="let category of getOrganizedCategories('expense'); trackBy: trackByCategory"
          >
            <!-- Parent Category Row -->
            <tr *ngIf="category.isParent" class="bg-red-100 font-semibold">
              <td
                class="px-4 py-2 border-b border-gray-200 sticky left-0 bg-red-100 z-10"
              >
                <div class="flex items-center gap-2">
                  <mat-icon
                    class="!w-5 !h-5 cursor-pointer"
                    (click)="toggleCategoryExpand(category.id)"
                  >
                    {{ isCategoryExpanded(category.id) ? 'expand_more' :
                    'chevron_right' }}
                  </mat-icon>
                  <input
                    type="text"
                    [value]="category.name"
                    [disabled]="!config.allowEdit"
                    (change)="onCategoryNameChange(category.id, $event)"
                    class="w-full px-2 py-1 font-semibold bg-transparent border border-transparent hover:border-gray-300 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 rounded"
                  />
                </div>
              </td>
              <td
                *ngFor="let month of months; trackBy: trackByMonth"
                class="px-4 py-2 text-right font-semibold border-b border-gray-200"
              >
                ${{ formatCurrency(getParentCategoryTotal(category, month.key))
                }}
              </td>
              <td
                *ngIf="config.showTotalColumn"
                class="px-4 py-2 text-right font-semibold border-b border-gray-200"
              >
                ${{ formatCurrency(getParentCategoryGrandTotal(category)) }}
              </td>
              <td class="px-4 py-2 border-b border-gray-200">
                <button
                  mat-mini-fab
                  color="primary"
                  (click)="onAddChildCategory(category.id)"
                  class="!bg-red-500 hover:!bg-red-600 !scale-75"
                  matTooltip="Add sub-category"
                >
                  <mat-icon class="!scale-90">add</mat-icon>
                </button>
                <button
                  *ngIf="config.allowDelete"
                  mat-mini-fab
                  color="warn"
                  (click)="onDeleteCategory(category.id)"
                  class="!scale-75 ml-1 hover:!bg-red-600"
                  matTooltip="Delete category group"
                >
                  <mat-icon class="!scale-90">delete</mat-icon>
                </button>
              </td>
            </tr>

            <!-- Child Categories (Indented) -->
            <ng-container
              *ngIf="category.isParent && isCategoryExpanded(category.id)"
            >
              <tr
                *ngFor="let child of getChildCategories(category.id)"
                class="hover:bg-gray-50"
              >
                <td
                  class="px-4 py-2 border-b border-gray-200 sticky left-0 bg-white z-10 pl-12"
                >
                  <div class="flex items-center gap-2">
                    <div class="w-4 h-4"></div>
                    <!-- Spacer for alignment -->
                    <input
                      type="text"
                      [value]="child.name"
                      [disabled]="!config.allowEdit"
                      (change)="onCategoryNameChange(child.id, $event)"
                      (keydown.enter)="onAddCategoryAfter(child.id, $event)"
                      class="w-full px-2 py-1 border border-transparent hover:border-gray-300 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 rounded"
                    />
                  </div>
                </td>
                <td
                  *ngFor="let month of months; trackBy: trackByMonth"
                  class="px-4 py-2 border-b border-gray-200"
                >
                  <input
                    type="number"
                    [value]="getCategoryValue(child, month.key)"
                    [disabled]="!config.allowEdit"
                    (blur)="onCellValueChange(child.id, month.key, $event)"
                    (contextmenu)="onContextMenu($event, child.id, month.key)"
                    class="w-full px-2 py-1 text-right border border-transparent hover:border-gray-300 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 rounded"
                    placeholder="0"
                    step="any"
                  />
                </td>
                <td
                  *ngIf="config.showTotalColumn"
                  class="px-4 py-2 text-right font-medium text-gray-700 border-b border-gray-200"
                >
                  ${{ formatCurrency(getCategoryTotal(child)) }}
                </td>
                <td class="px-4 py-2 border-b border-gray-200">
                  <button
                    *ngIf="config.allowDelete"
                    mat-mini-fab
                    color="warn"
                    (click)="onDeleteCategory(child.id)"
                    class="!scale-75 hover:!bg-red-600"
                    matTooltip="Delete sub-category"
                  >
                    <mat-icon class="!scale-90">delete</mat-icon>
                  </button>
                </td>
              </tr>
            </ng-container>

            <!-- Regular Category Row (No Parent) -->
            <tr
              *ngIf="!category.isParent && !category.parentId"
              class="hover:bg-gray-50"
            >
              <td
                class="px-4 py-2 border-b border-gray-200 sticky left-0 bg-white z-10"
              >
                <input
                  type="text"
                  [value]="category.name"
                  [disabled]="!config.allowEdit"
                  (change)="onCategoryNameChange(category.id, $event)"
                  (keydown.enter)="onAddCategoryAfter(category.id, $event)"
                  class="w-full px-2 py-1 border border-transparent hover:border-gray-300 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 rounded"
                />
              </td>
              <td
                *ngFor="let month of months; trackBy: trackByMonth"
                class="px-4 py-2 border-b border-gray-200"
              >
                <input
                  type="number"
                  [value]="getCategoryValue(category, month.key)"
                  [disabled]="!config.allowEdit"
                  (blur)="onCellValueChange(category.id, month.key, $event)"
                  (contextmenu)="onContextMenu($event, category.id, month.key)"
                  class="w-full px-2 py-1 text-right border border-transparent hover:border-gray-300 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 rounded"
                  placeholder="0"
                  step="any"
                />
              </td>
              <td
                *ngIf="config.showTotalColumn"
                class="px-4 py-2 text-right font-medium text-gray-700 border-b border-gray-200"
              >
                ${{ formatCurrency(getCategoryTotal(category)) }}
              </td>
              <td class="px-4 py-2 border-b border-gray-200">
                <button
                  *ngIf="config.allowDelete"
                  mat-mini-fab
                  color="warn"
                  (click)="onDeleteCategory(category.id)"
                  class="!scale-75 hover:!bg-red-600"
                  matTooltip="Delete Category"
                >
                  <mat-icon class="!scale-90">delete</mat-icon>
                </button>
              </td>
            </tr>
          </ng-container>
        </ng-container>

        <!-- Closing Balance -->
        <tr *ngIf="config.showClosingBalance" class="bg-blue-50 font-bold">
          <td
            class="px-4 py-3 text-gray-900 border-t-2 border-gray-300 sticky left-0 bg-blue-50 z-10"
          >
            Closing Balance
          </td>
          <td
            *ngFor="let month of months"
            class="px-4 py-3 text-right border-t-2 border-gray-300"
            [class.text-green-700]="(closingBalances[month.key] || 0) >= 0"
            [class.text-red-700]="(closingBalances[month.key] || 0) < 0"
          >
            ${{ formatCurrency(closingBalances[month.key] || 0) }}
          </td>
          <td
            *ngIf="config.showTotalColumn"
            class="px-4 py-3 border-t-2 border-gray-300"
          ></td>
          <td class="px-4 py-3 border-t-2 border-gray-300"></td>
        </tr>

        <!-- Grand Totals Footer -->
        <tr class="bg-gray-100 font-bold border-t-4 border-gray-300">
          <td class="px-4 py-3 sticky left-0 bg-gray-100 z-10">GRAND TOTALS</td>
          <td *ngFor="let month of months" class="px-4 py-3 text-right">
            <div class="text-green-700">
              Income: ${{ formatCurrency(incomeTotals[month.key] || 0) }}
            </div>
            <div class="text-red-700">
              Expenses: ${{ formatCurrency(expenseTotals[month.key] || 0) }}
            </div>
            <div class="text-blue-700">
              Net: ${{ formatCurrency((incomeTotals[month.key] || 0) -
              (expenseTotals[month.key] || 0)) }}
            </div>
          </td>
          <td *ngIf="config.showTotalColumn" class="px-4 py-3 text-right">
            <div class="text-green-700">
              ${{ formatCurrency(getTotalIncome()) }}
            </div>
            <div class="text-red-700">
              ${{ formatCurrency(getTotalExpenses()) }}
            </div>
            <div class="text-blue-700">
              ${{ formatCurrency(getTotalIncome() - getTotalExpenses()) }}
            </div>
          </td>
          <td class="px-4 py-3"></td>
        </tr>
      </tbody>
    </table>
  </div>
</div>
